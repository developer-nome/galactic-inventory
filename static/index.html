<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Inventory Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.delete {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.update {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .data-section {
            margin-top: 30px;
        }

        .data-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .item-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .item-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .item-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .item-card p {
            color: #666;
            margin-bottom: 5px;
        }

        .item-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .item-actions button {
            padding: 8px 15px;
            font-size: 12px;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .inventory-section {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .inventory-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            h1 {
                font-size: 1.8em;
            }

            .tab {
                padding: 12px 15px;
                font-size: 14px;
            }

            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåå Galactic Inventory Management</h1>
            <p class="subtitle">Manage your interstellar items, stations, and planets</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('items')">Items</button>
            <button class="tab" onclick="showTab('item-types')">Item Types</button>
            <button class="tab" onclick="showTab('stations')">Stations</button>
            <button class="tab" onclick="showTab('planets')">Planets</button>
        </div>

        <!-- Items Tab -->
        <div id="items" class="tab-content active">
            <div class="message" id="items-message"></div>

            <div class="form-section">
                <h3>Create New Item</h3>
                <form id="create-item-form">
                    <div class="form-group">
                        <label for="item-name">Name *</label>
                        <input type="text" id="item-name" required>
                    </div>
                    <div class="form-group">
                        <label for="item-type">Item Type</label>
                        <select id="item-type">
                            <option value="">No type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-description">Description</label>
                        <textarea id="item-description"></textarea>
                    </div>
                    <button type="submit">Create Item</button>
                </form>
            </div>

            <div class="data-section">
                <h3>All Items</h3>
                <div id="items-list"></div>
            </div>
        </div>

        <!-- Stations Tab -->
        <div id="stations" class="tab-content">
            <div class="message" id="stations-message"></div>

            <div class="form-section">
                <h3>Create New Station</h3>
                <form id="create-station-form">
                    <div class="form-group">
                        <label for="station-name">Name *</label>
                        <input type="text" id="station-name" required>
                    </div>
                    <div class="form-group">
                        <label for="station-description">Description</label>
                        <textarea id="station-description"></textarea>
                    </div>
                    <button type="submit">Create Station</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Filter by Item Type</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="filter-standard" checked onchange="applyStationFilters()">
                        <span>üì¶ Standard</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="filter-tech" checked onchange="applyStationFilters()">
                        <span>‚öôÔ∏è Tech</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="filter-trade" checked onchange="applyStationFilters()">
                        <span>üí∞ Trade</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="filter-no-type" checked onchange="applyStationFilters()">
                        <span>üìã No Type</span>
                    </label>
                </div>
            </div>

            <div class="data-section">
                <h3>All Stations</h3>
                <div id="stations-list"></div>
            </div>
        </div>

        <!-- Planets Tab -->
        <div id="planets" class="tab-content">
            <div class="message" id="planets-message"></div>

            <div class="form-section">
                <h3>Create New Planet</h3>
                <form id="create-planet-form">
                    <div class="form-group">
                        <label for="planet-name">Name *</label>
                        <input type="text" id="planet-name" required>
                    </div>
                    <div class="form-group">
                        <label for="planet-description">Description</label>
                        <textarea id="planet-description"></textarea>
                    </div>
                    <button type="submit">Create Planet</button>
                </form>
            </div>

            <div class="data-section">
                <h3>All Planets</h3>
                <div id="planets-list"></div>
            </div>
        </div>

        <!-- Item Types Tab -->
        <div id="item-types" class="tab-content">
            <div class="message" id="item-types-message"></div>

            <div class="form-section">
                <h3>Create New Item Type</h3>
                <form id="create-item-type-form">
                    <div class="form-group">
                        <label for="item-type-name">Name *</label>
                        <input type="text" id="item-type-name" required>
                    </div>
                    <div class="form-group">
                        <label for="item-type-description">Description</label>
                        <textarea id="item-type-description"></textarea>
                    </div>
                    <button type="submit">Create Item Type</button>
                </form>
            </div>

            <div class="data-section">
                <h3>All Item Types</h3>
                <div id="item-types-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            if (tabName === 'items') loadItems();
            if (tabName === 'item-types') loadItemTypes();
            if (tabName === 'stations') loadStations();
            if (tabName === 'planets') loadPlanets();
        }

        // Show messages
        function showMessage(section, message, type = 'success') {
            const messageEl = document.getElementById(`${section}-message`);
            messageEl.textContent = message;
            messageEl.className = `message ${type} show`;

            // Scroll to the message so it's visible
            messageEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        // Get icon for item type
        function getItemTypeIcon(itemTypeName) {
            if (!itemTypeName) return '';
            const icons = {
                'Standard': 'üì¶',
                'Tech': '‚öôÔ∏è',
                'Trade': 'üí∞'
            };
            return icons[itemTypeName] || 'üìã';
        }

        // ITEMS CRUD
        async function loadItems() {
            const listEl = document.getElementById('items-list');
            listEl.innerHTML = '<div class="loading">Loading items...</div>';

            try {
                // Load item types for the dropdown
                const itemTypesResponse = await fetch(`${API_BASE}/item-types`);
                const itemTypes = await itemTypesResponse.json();
                const itemTypeSelect = document.getElementById('item-type');
                itemTypeSelect.innerHTML = '<option value="">No type</option>' +
                    itemTypes.sort((a, b) => a.name.localeCompare(b.name))
                        .map(type => `<option value="${type.id}">${type.name}</option>`).join('');

                const response = await fetch(`${API_BASE}/items`);
                const items = await response.json();

                if (items.length === 0) {
                    listEl.innerHTML = '<p>No items found. Create one above!</p>';
                    return;
                }

                // Sort items alphabetically by name
                items.sort((a, b) => a.name.localeCompare(b.name));

                listEl.innerHTML = items.map(item => `
                    <div class="item-card">
                        <h4>${item.name}${item.description ? ' (' + item.description + ')' : ''}</h4>
                        ${item.item_type_name ? `<p><strong>Type:</strong> ${item.item_type_name}</p>` : ''}
                        <div class="item-actions">
                            <button class="update" onclick="updateItem(${item.id})">Update</button>
                            <button class="delete" onclick="deleteItem(${item.id})">Delete</button>
                            <button onclick="showItemStations(${item.id})">Show Stations</button>
                        </div>
                        <div class="inventory-section" id="item-stations-${item.id}" style="display: none;">
                            <h4>Stations with this item:</h4>
                            <div id="item-${item.id}-stations-list">
                                <div class="loading">Loading stations...</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = '<p class="error">Error loading items</p>';
                showMessage('items', 'Error loading items: ' + error.message, 'error');
            }
        }

        document.getElementById('create-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('item-name').value;
            const description = document.getElementById('item-description').value;
            const itemTypeId = document.getElementById('item-type').value;

            try {
                // Check if an item with this name already exists
                const checkResponse = await fetch(`${API_BASE}/items`);
                const existingItems = await checkResponse.json();

                const duplicateItem = existingItems.find(item =>
                    item.name.toLowerCase() === name.toLowerCase()
                );

                if (duplicateItem) {
                    showMessage('items', `An item with the name "${name}" already exists!`, 'error');
                    return;
                }

                // Proceed with creating the item
                const response = await fetch(`${API_BASE}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        item_type_id: itemTypeId ? parseInt(itemTypeId) : null
                    })
                });

                if (response.ok) {
                    showMessage('items', 'Item created successfully!');
                    e.target.reset();
                    loadItems();
                } else {
                    throw new Error('Failed to create item');
                }
            } catch (error) {
                showMessage('items', 'Error creating item: ' + error.message, 'error');
            }
        });

        async function updateItem(id) {
            const name = prompt('Enter new name:');
            if (!name) return;

            const description = prompt('Enter new description:') || '';

            // Note: Item type is set to null in updates via prompt
            // For better UX, consider implementing a modal dialog

            try {
                const response = await fetch(`${API_BASE}/items/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, item_type_id: null })
                });

                if (response.ok) {
                    showMessage('items', 'Item updated successfully!');
                    loadItems();
                } else {
                    throw new Error('Failed to update item');
                }
            } catch (error) {
                showMessage('items', 'Error updating item: ' + error.message, 'error');
            }
        }

        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                const response = await fetch(`${API_BASE}/items/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('items', 'Item deleted successfully!');
                    loadItems();
                } else {
                    throw new Error('Failed to delete item');
                }
            } catch (error) {
                showMessage('items', 'Error deleting item: ' + error.message, 'error');
            }
        }

        async function showItemStations(itemId) {
            const stationsDiv = document.getElementById(`item-stations-${itemId}`);
            stationsDiv.style.display = stationsDiv.style.display === 'none' ? 'block' : 'none';

            if (stationsDiv.style.display === 'block') {
                const stationsListDiv = document.getElementById(`item-${itemId}-stations-list`);

                try {
                    // Fetch all stations
                    const stationsResponse = await fetch(`${API_BASE}/stations`);
                    const allStations = await stationsResponse.json();

                    // Find stations that have this item
                    const stationsWithItem = [];
                    for (const station of allStations) {
                        const inventoryResponse = await fetch(`${API_BASE}/stations/${station.id}/inventory`);
                        const inventory = await inventoryResponse.json();

                        // Check if this station has the item
                        if (inventory.some(inv => inv.item_id === itemId)) {
                            stationsWithItem.push(station);
                        }
                    }

                    // Sort stations alphabetically by name
                    stationsWithItem.sort((a, b) => a.name.localeCompare(b.name));

                    // Display the stations
                    if (stationsWithItem.length === 0) {
                        stationsListDiv.innerHTML = '<p>This item is not in any station inventory</p>';
                    } else {
                        stationsListDiv.innerHTML = stationsWithItem.map(station => `
                            <div class="inventory-item">
                                <div>
                                    <strong>${station.name}</strong>
                                    ${station.description ? '<br><small>' + station.description + '</small>' : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    stationsListDiv.innerHTML = '<p class="error">Error loading stations</p>';
                }
            }
        }

        // ITEM TYPES CRUD
        async function loadItemTypes() {
            const listEl = document.getElementById('item-types-list');
            listEl.innerHTML = '<div class="loading">Loading item types...</div>';

            try {
                const response = await fetch(`${API_BASE}/item-types`);
                const itemTypes = await response.json();

                if (itemTypes.length === 0) {
                    listEl.innerHTML = '<p>No item types found. Create one above!</p>';
                    return;
                }

                listEl.innerHTML = itemTypes.map(itemType => `
                    <div class="item-card">
                        <h4>${itemType.name}${itemType.description ? ' (' + itemType.description + ')' : ''}</h4>
                        <div class="item-actions">
                            <button class="update" onclick="updateItemType(${itemType.id})">Update</button>
                            <button class="delete" onclick="deleteItemType(${itemType.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = '<p class="error">Error loading item types</p>';
                showMessage('item-types', 'Error loading item types: ' + error.message, 'error');
            }
        }

        document.getElementById('create-item-type-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('item-type-name').value;
            const description = document.getElementById('item-type-description').value;

            try {
                const response = await fetch(`${API_BASE}/item-types`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('item-types', 'Item type created successfully!');
                    e.target.reset();
                    loadItemTypes();
                } else {
                    throw new Error('Failed to create item type');
                }
            } catch (error) {
                showMessage('item-types', 'Error creating item type: ' + error.message, 'error');
            }
        });

        async function updateItemType(id) {
            const name = prompt('Enter new name:');
            if (!name) return;

            const description = prompt('Enter new description:') || '';

            try {
                const response = await fetch(`${API_BASE}/item-types/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('item-types', 'Item type updated successfully!');
                    loadItemTypes();
                } else {
                    throw new Error('Failed to update item type');
                }
            } catch (error) {
                showMessage('item-types', 'Error updating item type: ' + error.message, 'error');
            }
        }

        async function deleteItemType(id) {
            if (!confirm('Are you sure you want to delete this item type?')) return;

            try {
                const response = await fetch(`${API_BASE}/item-types/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('item-types', 'Item type deleted successfully!');
                    loadItemTypes();
                } else {
                    throw new Error('Failed to delete item type');
                }
            } catch (error) {
                showMessage('item-types', 'Error deleting item type: ' + error.message, 'error');
            }
        }

        // STATIONS CRUD
        // Get active item type filters
        function getActiveItemTypeFilters() {
            return {
                'Standard': document.getElementById('filter-standard').checked,
                'Tech': document.getElementById('filter-tech').checked,
                'Trade': document.getElementById('filter-trade').checked,
                'No Type': document.getElementById('filter-no-type').checked
            };
        }

        // Check if an item should be shown based on filters
        function shouldShowItem(itemTypeName) {
            const filters = getActiveItemTypeFilters();
            const typeKey = itemTypeName || 'No Type';
            return filters[typeKey] === true;
        }

        // Apply filters by reloading stations
        function applyStationFilters() {
            loadStations();
        }

        async function loadStations() {
            const listEl = document.getElementById('stations-list');
            listEl.innerHTML = '<div class="loading">Loading stations...</div>';

            try {
                const response = await fetch(`${API_BASE}/stations`);
                const stations = await response.json();

                if (stations.length === 0) {
                    listEl.innerHTML = '<p>No stations found. Create one above!</p>';
                    return;
                }

                // Sort stations alphabetically by name
                stations.sort((a, b) => a.name.localeCompare(b.name));

                listEl.innerHTML = '';
                for (const station of stations) {
                    const inventoryResponse = await fetch(`${API_BASE}/stations/${station.id}/inventory`);
                    let inventory = await inventoryResponse.json();

                    // Filter inventory based on item type checkboxes
                    inventory = inventory.filter(inv => shouldShowItem(inv.item_type_name));

                    // Sort inventory items alphabetically by item name
                    inventory.sort((a, b) => a.item_name.localeCompare(b.item_name));

                    const stationCard = document.createElement('div');
                    stationCard.className = 'item-card';
                    stationCard.innerHTML = `
                        <h4>${station.name}${station.description ? ' (' + station.description + ')' : ''}</h4>
                        <div class="item-actions">
                            <button class="update" onclick="updateStation(${station.id})">Update</button>
                            <button class="delete" onclick="deleteStation(${station.id})">Delete</button>
                            <button onclick="showStationInventory(${station.id})">Manage Inventory</button>
                        </div>
                        <div class="inventory-section" id="station-inventory-${station.id}" style="display: none;">
                            <h4>Inventory</h4>
                            <div class="form-group">
                                <label>Add Item to Inventory:</label>
                                <select id="station-${station.id}-item-select" onchange="handleStationItemSelect(${station.id})">
                                    <option value="">Select an item...</option>
                                </select>
                                <button onclick="addToStationInventory(${station.id})" style="margin-top: 10px;">Add Item</button>
                            </div>
                            <div id="station-${station.id}-new-item-form" style="display: none; background: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 10px;">
                                <h4 style="margin-bottom: 10px;">Create New Item</h4>
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="station-${station.id}-new-item-name" required>
                                </div>
                                <div class="form-group">
                                    <label>Item Type</label>
                                    <select id="station-${station.id}-new-item-type">
                                        <option value="">No type</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="station-${station.id}-new-item-description"></textarea>
                                </div>
                                <button onclick="createAndAddNewItem(${station.id})" style="margin-right: 10px;">Create & Add to Inventory</button>
                                <button onclick="cancelNewItem(${station.id})" class="update">Cancel</button>
                            </div>
                            <div class="message" id="station-${station.id}-inventory-message" style="display: none; margin-top: 10px;"></div>
                            <div id="station-${station.id}-inventory-list">
                                ${inventory.length === 0 ? '<p>No items in inventory</p>' : inventory.map(inv => `
                                    <div class="inventory-item">
                                        <div>
                                            <strong>${getItemTypeIcon(inv.item_type_name)} ${inv.item_name}</strong> - <small>${inv.item_description || 'No description'}</small>
                                        </div>
                                        <button class="delete" onclick="removeFromStationInventory(${station.id}, ${inv.inventory_id})" style="padding: 6px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(stationCard);
                }
            } catch (error) {
                listEl.innerHTML = '<p class="error">Error loading stations</p>';
                showMessage('stations', 'Error loading stations: ' + error.message, 'error');
            }
        }

        async function showStationInventory(stationId) {
            const inventoryDiv = document.getElementById(`station-inventory-${stationId}`);
            inventoryDiv.style.display = inventoryDiv.style.display === 'none' ? 'block' : 'none';

            if (inventoryDiv.style.display === 'block') {
                const itemsResponse = await fetch(`${API_BASE}/items`);
                let items = await itemsResponse.json();

                // Filter items based on item type checkboxes
                items = items.filter(item => shouldShowItem(item.item_type_name));

                // Sort items alphabetically by name
                items.sort((a, b) => a.name.localeCompare(b.name));

                const select = document.getElementById(`station-${stationId}-item-select`);
                select.innerHTML = '<option value="">Select an item...</option>' +
                    '<option value="__new__">‚ûï Add New Item</option>' +
                    items.map(item => `<option value="${item.id}">${getItemTypeIcon(item.item_type_name)} ${item.name}</option>`).join('');

                // Populate item types for the new item form
                const itemTypesResponse = await fetch(`${API_BASE}/item-types`);
                const itemTypes = await itemTypesResponse.json();
                const newItemTypeSelect = document.getElementById(`station-${stationId}-new-item-type`);
                newItemTypeSelect.innerHTML = '<option value="">No type</option>' +
                    itemTypes.sort((a, b) => a.name.localeCompare(b.name))
                        .map(type => `<option value="${type.id}">${type.name}</option>`).join('');
            }
        }

        // Handle station item select dropdown change
        function handleStationItemSelect(stationId) {
            const select = document.getElementById(`station-${stationId}-item-select`);
            const newItemForm = document.getElementById(`station-${stationId}-new-item-form`);

            if (select.value === '__new__') {
                newItemForm.style.display = 'block';
            } else {
                newItemForm.style.display = 'none';
            }
        }

        // Cancel creating new item
        function cancelNewItem(stationId) {
            const newItemForm = document.getElementById(`station-${stationId}-new-item-form`);
            const select = document.getElementById(`station-${stationId}-item-select`);

            newItemForm.style.display = 'none';
            select.value = '';

            // Clear form fields
            document.getElementById(`station-${stationId}-new-item-name`).value = '';
            document.getElementById(`station-${stationId}-new-item-type`).value = '';
            document.getElementById(`station-${stationId}-new-item-description`).value = '';
        }

        // Create new item and add to station inventory
        async function createAndAddNewItem(stationId) {
            const name = document.getElementById(`station-${stationId}-new-item-name`).value;
            const description = document.getElementById(`station-${stationId}-new-item-description`).value;
            const itemTypeId = document.getElementById(`station-${stationId}-new-item-type`).value;

            if (!name) {
                showStationInventoryMessage(stationId, 'Item name is required!', 'error');
                return;
            }

            try {
                // Check if an item with this name already exists
                const checkResponse = await fetch(`${API_BASE}/items`);
                const existingItems = await checkResponse.json();

                const duplicateItem = existingItems.find(item =>
                    item.name.toLowerCase() === name.toLowerCase()
                );

                if (duplicateItem) {
                    showStationInventoryMessage(stationId, `An item with the name "${name}" already exists!`, 'error');
                    return;
                }

                // Create the new item
                const createResponse = await fetch(`${API_BASE}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        item_type_id: itemTypeId ? parseInt(itemTypeId) : null
                    })
                });

                if (!createResponse.ok) {
                    throw new Error('Failed to create item');
                }

                const newItem = await createResponse.json();

                // Add the new item to the station's inventory
                const addResponse = await fetch(`${API_BASE}/stations/${stationId}/inventory?item_id=${newItem.id}`, {
                    method: 'POST'
                });

                if (addResponse.ok) {
                    showStationInventoryMessage(stationId, `Item "${name}" created and added to inventory!`, 'success');
                    cancelNewItem(stationId);
                    await refreshStationInventory(stationId);
                } else {
                    throw new Error('Failed to add item to inventory');
                }
            } catch (error) {
                showStationInventoryMessage(stationId, 'Error: ' + error.message, 'error');
            }
        }

        async function refreshStationInventory(stationId) {
            const inventoryResponse = await fetch(`${API_BASE}/stations/${stationId}/inventory`);
            let inventory = await inventoryResponse.json();

            // Filter inventory based on item type checkboxes
            inventory = inventory.filter(inv => shouldShowItem(inv.item_type_name));

            // Sort inventory items alphabetically by item name
            inventory.sort((a, b) => a.item_name.localeCompare(b.item_name));

            const inventoryListDiv = document.getElementById(`station-${stationId}-inventory-list`);
            inventoryListDiv.innerHTML = inventory.length === 0 ? '<p>No items in inventory</p>' : inventory.map(inv => `
                <div class="inventory-item">
                    <div>
                        <strong>${getItemTypeIcon(inv.item_type_name)} ${inv.item_name}</strong> - <small>${inv.item_description || 'No description'}</small>
                    </div>
                    <button class="delete" onclick="removeFromStationInventory(${stationId}, ${inv.inventory_id})" style="padding: 6px 12px; font-size: 12px;">Remove</button>
                </div>
            `).join('');
        }

        // Show message in station inventory section
        function showStationInventoryMessage(stationId, message, type = 'success') {
            const messageEl = document.getElementById(`station-${stationId}-inventory-message`);
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        async function addToStationInventory(stationId) {
            const select = document.getElementById(`station-${stationId}-item-select`);
            const itemId = select.value;

            if (!itemId) {
                alert('Please select an item');
                return;
            }

            try {
                // Check if the item already exists in this station's inventory
                const inventoryResponse = await fetch(`${API_BASE}/stations/${stationId}/inventory`);
                const inventory = await inventoryResponse.json();

                const duplicateItem = inventory.find(inv => inv.item_id === parseInt(itemId));

                if (duplicateItem) {
                    showStationInventoryMessage(stationId, `"${duplicateItem.item_name}" is already in this station's inventory!`, 'error');
                    return;
                }

                // Proceed with adding the item
                const response = await fetch(`${API_BASE}/stations/${stationId}/inventory?item_id=${itemId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showStationInventoryMessage(stationId, 'Item added to inventory!', 'success');
                    select.value = ''; // Reset dropdown
                    await refreshStationInventory(stationId);
                } else {
                    throw new Error('Failed to add item to inventory');
                }
            } catch (error) {
                showStationInventoryMessage(stationId, 'Error: ' + error.message, 'error');
            }
        }

        async function removeFromStationInventory(stationId, inventoryId) {
            if (!confirm('Remove this item from inventory?')) return;

            try {
                const response = await fetch(`${API_BASE}/stations/${stationId}/inventory/${inventoryId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('stations', 'Item removed from inventory!');
                    await refreshStationInventory(stationId);
                } else {
                    throw new Error('Failed to remove item');
                }
            } catch (error) {
                showMessage('stations', 'Error: ' + error.message, 'error');
            }
        }

        document.getElementById('create-station-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('station-name').value;
            const description = document.getElementById('station-description').value;

            try {
                const response = await fetch(`${API_BASE}/stations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('stations', 'Station created successfully!');
                    e.target.reset();
                    loadStations();
                } else {
                    throw new Error('Failed to create station');
                }
            } catch (error) {
                showMessage('stations', 'Error creating station: ' + error.message, 'error');
            }
        });

        async function updateStation(id) {
            const name = prompt('Enter new name:');
            if (!name) return;

            const description = prompt('Enter new description:') || '';

            try {
                const response = await fetch(`${API_BASE}/stations/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('stations', 'Station updated successfully!');
                    loadStations();
                } else {
                    throw new Error('Failed to update station');
                }
            } catch (error) {
                showMessage('stations', 'Error updating station: ' + error.message, 'error');
            }
        }

        async function deleteStation(id) {
            if (!confirm('Are you sure you want to delete this station?')) return;

            try {
                const response = await fetch(`${API_BASE}/stations/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('stations', 'Station deleted successfully!');
                    loadStations();
                } else {
                    throw new Error('Failed to delete station');
                }
            } catch (error) {
                showMessage('stations', 'Error deleting station: ' + error.message, 'error');
            }
        }

        // PLANETS CRUD
        async function loadPlanets() {
            const listEl = document.getElementById('planets-list');
            listEl.innerHTML = '<div class="loading">Loading planets...</div>';

            try {
                const response = await fetch(`${API_BASE}/planets`);
                const planets = await response.json();

                if (planets.length === 0) {
                    listEl.innerHTML = '<p>No planets found. Create one above!</p>';
                    return;
                }

                listEl.innerHTML = planets.map(planet => `
                    <div class="item-card">
                        <h4>${planet.name}</h4>
                        <p><strong>ID:</strong> ${planet.id}</p>
                        <p><strong>Description:</strong> ${planet.description || 'N/A'}</p>
                        <div class="item-actions">
                            <button class="update" onclick="updatePlanet(${planet.id})">Update</button>
                            <button class="delete" onclick="deletePlanet(${planet.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = '<p class="error">Error loading planets</p>';
                showMessage('planets', 'Error loading planets: ' + error.message, 'error');
            }
        }

        document.getElementById('create-planet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('planet-name').value;
            const description = document.getElementById('planet-description').value;

            try {
                const response = await fetch(`${API_BASE}/planets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('planets', 'Planet created successfully!');
                    e.target.reset();
                    loadPlanets();
                } else {
                    throw new Error('Failed to create planet');
                }
            } catch (error) {
                showMessage('planets', 'Error creating planet: ' + error.message, 'error');
            }
        });

        async function updatePlanet(id) {
            const name = prompt('Enter new name:');
            if (!name) return;

            const description = prompt('Enter new description:') || '';

            try {
                const response = await fetch(`${API_BASE}/planets/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showMessage('planets', 'Planet updated successfully!');
                    loadPlanets();
                } else {
                    throw new Error('Failed to update planet');
                }
            } catch (error) {
                showMessage('planets', 'Error updating planet: ' + error.message, 'error');
            }
        }

        async function deletePlanet(id) {
            if (!confirm('Are you sure you want to delete this planet?')) return;

            try {
                const response = await fetch(`${API_BASE}/planets/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('planets', 'Planet deleted successfully!');
                    loadPlanets();
                } else {
                    throw new Error('Failed to delete planet');
                }
            } catch (error) {
                showMessage('planets', 'Error deleting planet: ' + error.message, 'error');
            }
        }

        // Load items on page load
        loadItems();
    </script>
</body>
</html>
